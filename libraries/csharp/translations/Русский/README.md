# SA-MP Injector C#

<div align="center">

![C#](https://img.shields.io/badge/C%23-11.0%2B-512BD4?style=for-the-badge&logo=csharp&logoColor=white)
![.NET](https://img.shields.io/badge/.NET-7.0%2B-512BD4?style=for-the-badge&logo=dotnet&logoColor=white)
![Platform](https://img.shields.io/badge/Platform-Windows-blue?style=for-the-badge&logo=windows&logoColor=white)
![Architecture](https://img.shields.io/badge/Architecture-x86%20(32--bit)-lightgrey?style=for-the-badge)
![License](https://img.shields.io/badge/License-MIT-green?style=for-the-badge)

**Библиотека C# для программной инъекции DLL в процессы SA-MP и OMP, позволяющая автоматизировать подключение к серверам.**

</div>

## Языки

- Português: [README](../../)
- Deutsch: [README](../Deutsch/README.md)
- English: [README](../English/README.md)
- Español: [README](../Espanol/README.md)
- Français: [README](../Francais/README.md)
- Italiano: [README](../Italiano/README.md)
- Polski: [README](../Polski/README.md)
- Svenska: [README](../Svenska/README.md)
- Türkçe: [README](../Turkce/README.md)

## Содержание

- [SA-MP Injector C#](#sa-mp-injector-c)
  - [Языки](#языки)
  - [Содержание](#содержание)
  - [Введение и назначение](#введение-и-назначение)
  - [Философия дизайна](#философия-дизайна)
    - [Взаимодействие (P/Invoke)](#взаимодействие-pinvoke)
    - [Управление ресурсами (`SafeHandle`)](#управление-ресурсами-safehandle)
    - [Безопасность и надежность](#безопасность-и-надежность)
  - [Системные требования](#системные-требования)
    - [Среда разработки](#среда-разработки)
    - [Среда выполнения](#среда-выполнения)
  - [Установка и базовое использование](#установка-и-базовое-использование)
    - [Добавление в ваш проект](#добавление-в-ваш-проект)
    - [Пример использования](#пример-использования)
  - [Компоненты библиотеки](#компоненты-библиотеки)
    - [1. `Constants.cs`](#1-constantscs)
    - [2. `InjectionType.cs`](#2-injectiontypecs)
    - [3. `Injector.cs`](#3-injectorcs)
    - [4. `InjectorCore.cs`](#4-injectorcorecs)
    - [5. `InputValidator.cs`](#5-inputvalidatorcs)
    - [6. `NativeImports.cs`](#6-nativeimportscs)
    - [7. `ProcessHandler.cs`](#7-processhandlercs)
    - [8. `SafeHandles.cs`](#8-safehandlescs)
  - [Подробный цикл инъекции DLL](#подробный-цикл-инъекции-dll)
    - [1. Проверка ввода](#1-проверка-ввода)
    - [2. Создание игрового процесса (приостановленного)](#2-создание-игрового-процесса-приостановленного)
    - [3. Инъекция `samp.dll`](#3-инъекция-sampdll)
    - [4. Инъекция `omp-client.dll` (необязательно, зависит от SA-MP)](#4-инъекция-omp-clientdll-необязательно-зависит-от-sa-mp)
    - [Возобновление основного потока игры](#возобновление-основного-потока-игры)
  - [Обработка ошибок и сбоев](#обработка-ошибок-и-сбоев)
    - [Ошибки проверки ввода](#ошибки-проверки-ввода)
      - [Неверный никнейм](#неверный-никнейм)
      - [Неверный порт](#неверный-порт)
      - [Отсутствующие файлы игры/DLL](#отсутствующие-файлы-игрыdll)
    - [Ошибки при создании процесса](#ошибки-при-создании-процесса)
      - [Ошибка создания процесса](#ошибка-создания-процесса)
    - [Ошибки при инъекции DLL](#ошибки-при-инъекции-dll)
      - [Недоступен дескриптор `kernel32.dll`](#недоступен-дескриптор-kernel32dll)
      - [Недоступна функция `LoadLibraryA`](#недоступна-функция-loadlibrarya)
      - [Ошибка выделения удаленной памяти](#ошибка-выделения-удаленной-памяти)
      - [Ошибка записи в память процесса](#ошибка-записи-в-память-процесса)
      - [Ошибка создания удаленного потока](#ошибка-создания-удаленного-потока)
      - [Тайм-аут или ошибка ожидания инъекции](#тайм-аут-или-ошибка-ожидания-инъекции)
      - [Инъекция DLL не удалась или вернула ошибку](#инъекция-dll-не-удалась-или-вернула-ошибку)
    - [Ошибка при возобновлении потока игры](#ошибка-при-возобновлении-потока-игры)
  - [Лицензия](#лицензия)
    - [Условия использования](#условия-использования)
      - [1. Предоставленные разрешения](#1-предоставленные-разрешения)
      - [2. Обязательные условия](#2-обязательные-условия)
      - [3. Авторские права](#3-авторские-права)
      - [4. Отказ от гарантий и ограничение ответственности](#4-отказ-от-гарантий-и-ограничение-ответственности)

## Введение и назначение

Библиотека **SA-MP Injector C#** — это решение на C#, предназначенное для упрощения автоматического запуска и подключения клиентов San Andreas Multiplayer (SA-MP) и Open Multiplayer (OMP) к серверам. Она действует как инструмент для инъекции DLL (Dynamic Link Library), программно загружая библиотеки `samp.dll` или `omp-client.dll` в процесс игры Grand Theft Auto: San Andreas (`gta_sa.exe`).

Основная цель этой библиотеки — позволить другим приложениям на C# (таким как пользовательские лаунчеры, инструменты управления сервером или утилиты) запускать игру с определенными параметрами (никнейм, IP-адрес, порт и пароль) прозрачно для пользователя, автоматизируя процесс подключения к серверу SA-MP/OMP.

## Философия дизайна

Дизайн **SA-MP Injector C#** сосредоточен на надежности, безопасности и упрощенном интерфейсе использования, инкапсулируя сложности низкоуровневых системных операций.

### Взаимодействие (P/Invoke)

Основная функциональность инъекции DLL и создания приостановленных процессов по своей сути является низкоуровневой операцией операционной системы. Для этого библиотека широко использует функцию **P/Invoke (Platform Invoke)** .NET, позволяя вызывать нативные функции Windows API (в основном из `kernel32.dll`) непосредственно из кода C#. Это видно в объявлении методов `partial` и использовании атрибута `[LibraryImport(KERNEL32, SetLastError = true)]`.

### Управление ресурсами (`SafeHandle`)

Операции с ресурсами операционной системы, такими как "дескрипторы" процессов и потоков, требуют тщательного управления во избежание утечек памяти или ресурсов. Библиотека использует классы, производные от `SafeHandle` (`SafeProcessHandle` и `SafeThreadHandle`), чтобы гарантировать, что эти ресурсы всегда освобождаются корректно, даже в случае исключений. Это соответствует принципу **RAII (Resource Acquisition Is Initialization)** из C++ и расширяет его на среду .NET.

### Безопасность и надежность

Библиотека включает несколько уровней безопасности:
- **Проверка ввода:** Все входные данные, предоставленные пользователем, строго проверяются перед началом любой критической операции, что минимизирует риск ошибок времени выполнения или непредвиденного поведения.
- **Обработка ошибок:** Вызовы нативных API сопровождаются проверками ошибок (`SetLastError = true` и `Marshal.GetLastWin32Error()`) для предоставления подробных и понятных сообщений об ошибках.
- **Завершение процесса:** В случае сбоя в процессе инъекции, только что созданный игровой процесс автоматически завершается, чтобы избежать "зомби"-процессов.

## Системные требования

### Среда разработки

- **.NET SDK 7.0 или выше:** Библиотека создана для `net7.0-windows`.
- **C# 11.0 или выше:** Требуется для таких функций, как `ImplicitUsings`, `Nullable`, `AllowUnsafeBlocks` и `LibraryImport`.
- **Visual Studio 2022 или совместимая среда разработки:** Для сборки и интеграции библиотеки.
- **Платформа компиляции:** `x86 (32-bit)` является обязательной целью из-за архитектуры `gta_sa.exe` и DLL-библиотек SA-MP/OMP.

```xml
<!-- samp-injector-csharp.csproj -->
<Project Sdk="Microsoft.NET.Sdk">
    <PropertyGroup>
        <TargetFrameworks>net7.0-windows</TargetFrameworks>
        <PlatformTarget>x86</PlatformTarget> <!-- КРИТИЧЕСКИ: Должно быть x86 -->
        <ImplicitUsings>enable</ImplicitUsings>
        <Nullable>enable</Nullable>
        <UseWindowsForms>true</UseWindowsForms>
        <AllowUnsafeBlocks>true</AllowUnsafeBlocks> <!-- Необходимо для расширенного P/Invoke -->
    </PropertyGroup>
</Project>
```

### Среда выполнения

- **Операционная система:** Windows (любая современная версия, совместимая с .NET 7.0+).
- **Grand Theft Auto: San Andreas (GTA: SA):** Требуется установленная игра.
- **Клиентские DLL SA-MP или OMP:** `samp.dll` или `omp-client.dll` должны находиться в корневом каталоге игры в зависимости от желаемого типа инъекции.

## Установка и базовое использование

### Добавление в ваш проект

Самый простой способ использовать эту библиотеку — добавить проект `Samp_Injector_CSharp` как ссылку в ваш собственный проект C#.

1. Клонируйте или скачайте репозиторий библиотеки.
2. В Visual Studio щелкните правой кнопкой мыши по "Dependencies" (или "Ссылки") в вашем проекте.
3. Выберите "Add Project Reference...".
4. Перейдите в каталог библиотеки и добавьте проект `samp-injector-csharp.csproj`.

### Пример использования

Чтобы запустить игру и подключиться к серверу, просто вызовите статический метод `Injector.Initialize_Game`.

```csharp
using Samp_Injector_CSharp;
using System;
using System.Windows.Forms; // Для MessageBox, если это не проект WinForms

namespace Launcher {
    public partial class Main : Form {
        public Main() {
            InitializeComponent();
        }

        private void Connect(object sender, EventArgs e) {
            string inject_type = "SAMP"; // "SAMP" или "OMP"
            string game_folder = @"C:\Games\GTA San Andreas"; // Путь к папке GTA: SA
            string nickname = "Имя";
            string ip = "127.0.0.1";
            string port = "7777";
            string password = ""; // Оставьте пустым, если пароля нет

            // Пример инъекции SA-MP
            Injector.Initialize_Game(inject_type, game_folder, nickname, ip, port, password);

            // Если OMP, измените inject_type:
            // inject_type = "OMP";
            // Injector.Initialize_Game(inject_type, game_folder, nickname, ip, port, password);
        }
    }
}
```

## Компоненты библиотеки

Библиотека структурирована на несколько файлов, каждый из которых имеет четкую и хорошо определенную ответственность, что способствует организации, поддержке и разделению обязанностей. Ниже приведено подробное описание каждого компонента.

### 1. `Constants.cs`

Этот файл является централизованным хранилищем всех констант и неизменяемых значений, используемых во всей библиотеке. Его существование способствует поддержке кода, читаемости и согласованности, гарантируя, что критические значения определены в одном месте.

Организация констант по категориям облегчает понимание их назначения:

- **Game Related Constants**
   - `MIN_PORT`: Определяет минимально допустимое значение для порта подключения к серверу (1).
   - `MAX_PORT`: Определяет максимально допустимое значение для порта подключения к серверу (65535).
   - `MAX_NICKNAME_LENGTH`: Указывает максимальную допустимую длину никнейма игрока (23 символа), ограничение, наложенное самим клиентом SA-MP/OMP.

- **File Names**
   - `SAMP_DLL_NAME`: Имя файла основной библиотеки клиента SA-MP (`"samp.dll"`).
   - `OMP_DLL_NAME`: Имя файла библиотеки клиента Open Multiplayer (`"omp-client.dll"`), используемой при инъекциях типа OMP.
   - `GAME_EXE_NAME`: Имя исполняемого файла игры Grand Theft Auto: San Andreas (`"gta_sa.exe"`).

- **System Libraries and Functions**
   - `KERNEL32_DLL`: Имя системной библиотеки Windows, содержащей основные функции для управления процессами и памятью (`"kernel32.dll"`).
   - `LOAD_LIBRARY_FUNC`: Имя функции в `kernel32.dll`, ответственной за динамическую загрузку библиотеки (`"LoadLibraryA"`).

- **Command Line Arguments**
   - `CMD_ARGS_PART1`: Начальная часть аргументов командной строки для игры (`"-c -n "`).
   - `CMD_ARGS_PART2`: Разделитель для IP-адреса (`" -h "`).
   - `CMD_ARGS_PART3`: Разделитель для порта (`" -p "`).
   - `CMD_ARGS_PART4_PASSWORD`: Префикс для аргумента пароля (`" -z "`), используется только при наличии пароля.
   - `CMD_ARGS_BASE_LENGTH`: Предопределенная длина постоянных частей командной строки, исключая исполняемый файл и пользовательские значения (14 символов).
   - `CMD_ARG_PASSWORD_LENGTH`: Длина префикса аргумента пароля (4 символа).

- **Error Message Titles**
   - `ERROR_TITLE_SAMP`: Стандартный заголовок для диалоговых окон ошибок, связанных со сбоями SA-MP (`"SA-MP Injector Error - SPC"`).
   - `ERROR_TITLE_OMP`: Стандартный заголовок для диалоговых окон ошибок, связанных со сбоями OMP (`"OMP Injector Error - SPC"`).

- **Process Creation Flags**
   - `CREATE_SUSPENDED`: Флаг, который указывает операционной системе создать процесс и его основной поток в приостановленном состоянии (`0x00000004`). Это крайне важно для инъекции DLL до того, как игра начнет выполняться.
   - `PROCESS_CREATION_FLAGS`: Комбинация флагов создания процесса, в настоящее время определенная только как `CREATE_SUSPENDED`.

- **Timeouts**
   - `DLL_INJECTION_TIMEOUT_MS`: Максимальное время (в миллисекундах), которое библиотека будет ожидать завершения удаленного потока, ответственного за инъекцию DLL (10000 мс = 10 секунд).

- **Memory Allocation Flags**
   - `MEM_COMMIT`: Флаг, который резервирует страницы в виртуальной памяти и "коммитит" их (выделяет физическую память) (`0x1000`).
   - `MEM_RESERVE`: Флаг, который только резервирует диапазон виртуального адресного пространства для последующего использования (`0x2000`).
   - `MEM_RELEASE`: Флаг, который декоммитит и освобождает регион страниц (`0x8000`).
   - `MEMORY_ALLOCATION_TYPE`: Комбинация `MEM_COMMIT` и `MEM_RESERVE`, используемая для выделения памяти под путь к DLL в удаленном процессе.
   - `MEMORY_PROTECTION`: Определяет разрешения защиты памяти (в настоящее время `0x04`, что соответствует `PAGE_READWRITE` в Windows API, разрешая чтение и запись в выделенную память).

### 2. `InjectionType.cs`

Этот файл определяет простое перечисление для безопасного и ясного указания типа выполняемой инъекции. Использование `enum` вместо строк (`"samp"`, `"omp"`) предотвращает опечатки и делает код более читаемым и надежным.

```csharp
// InjectionType.cs
namespace Samp_Injector_CSharp {
    public enum Injection_Type {
        SAMP,
        OMP
    }
}
```

### 3. `Injector.cs`

Этот файл является публичным фасадом библиотеки, служащим единственной точкой входа для клиентских приложений. Он абстрагирует всю внутреннюю сложность процесса инъекции в одном статическом методе.

- **Основная ответственность:** Метод `Initialize_Game` получает все необходимые параметры в виде строк, определяет тип инъекции и делегирует работу `Injector_Core`. Он также отвечает за получение результата операции и отображение сообщений об ошибках конечному пользователю через `MessageBox`, делая взаимодействие с конечным пользователем последовательным.

```csharp
// Фрагмент из Injector.cs
public static class Injector {
    private static readonly Injector_Core s_core = new();

    public static void Initialize_Game(string inject_type_str, string folder, string nickname, string ip, string port, string password) {
        // ... Логика для преобразования inject_type_str в Injection_Type ...

        if (!s_core.Try_Initialize_Game(type, folder, nickname, ip, port, password, out string error_message)) {
            string error_title = (type == Injection_Type.OMP) ? Constants.ERROR_TITLE_OMP : Constants.ERROR_TITLE_SAMP;
            MessageBox.Show(error_message, error_title, MessageBoxButtons.OK, MessageBoxIcon.Error);
        }
    }
}
```

### 4. `InjectorCore.cs`

Это "мозг" библиотеки, где организуется последовательность операций инъекции. Он связывает валидаторы ввода с обработчиками процессов для выполнения полного рабочего процесса.

- **Основная ответственность:** Метод `Try_Initialize_Game` определяет пошаговую логику: проверяет входные данные, создает игровой процесс в приостановленном состоянии, внедряет необходимые DLL (`samp.dll` и, опционально, `omp-client.dll`) и, если все успешно, возобновляет поток игры. Ключевым аспектом является блок `finally`, который гарантирует, что игровой процесс будет завершен (`Kill()`) в случае любого сбоя на этапах инъекции, предотвращая появление "зомби"-процессов.

```csharp
// Фрагмент из InjectorCore.cs
internal sealed class Injector_Core {
    public bool Try_Initialize_Game(...) {
        // ... Проверка ввода ...

        using Process_Handler.Process_Info process_info = Process_Handler.Create_Game_Process(...);
        
        // ...
        bool success = false;
        try {
            // ... Инъекция samp.dll ...
            // ... Необязательная инъекция omp-client.dll ...
            // ... Возобновление потока игры ...
            success = true;
            return true;
        }
        finally {
            if (!success && !process_info.ProcessHandle.IsInvalid) 
                process_info.ProcessHandle.Kill();
        }
    }
}
```

### 5. `InputValidator.cs`

Действует как первая линия защиты библиотеки, гарантируя, что обрабатываются только действительные и безопасные данные. Предварительная проверка предотвращает низкоуровневые исключения и позволяет библиотеке предоставлять ясные и действенные сообщения об ошибках.

- **Основная ответственность:** Статический метод `Try_Validate` выполняет серию проверок, включая формат никнейма, числовой диапазон порта и, что критически важно, наличие основных файлов (`gta_sa.exe`, `samp.dll` и т. д.) в указанном каталоге. Если какая-либо проверка не проходит, он возвращает `false` и заполняет `out string` с описанием ошибки.

```csharp
// Фрагмент из InputValidator.cs
internal static class Input_Validator {
    public static bool Try_Validate(...) {
        if (nickname.Length > Constants.MAX_NICKNAME_LENGTH)
            return (error_message = $"Nickname length exceeds the maximum...") != null && false;

        string game_exe_path = Path.Combine(folder_path, Constants.GAME_EXE_NAME);
        if (!File.Exists(game_exe_path))
            return (error_message = $"Game executable not found...") != null && false;
        
        // ...
        return true;
    }
}
```

### 6. `NativeImports.cs`

Этот файл является мостом между управляемым кодом C# и неуправляемыми нативными API Windows. Он использует функцию взаимодействия P/Invoke для объявления сигнатур функций из `kernel32.dll`.

- **Основная ответственность:** Объявлять методы `extern` с атрибутами `[LibraryImport]` или `[DllImport]`, которые соответствуют функциям Windows API, таким как `CreateProcessA`, `VirtualAllocEx` и `CreateRemoteThread`. Он также определяет структуры данных (`Startup_Info`, `Process_Information`) с раскладкой памяти, совместимой с нативным кодом. Для оптимизации дескрипторы для `kernel32.dll` и адрес функции `LoadLibraryA` загружаются статически при инициализации.

```csharp
// Фрагмент из NativeImports.cs
internal static unsafe partial class Native_Imports {
    private const string KERNEL32 = Constants.KERNEL32_DLL;
    
    internal static readonly IntPtr load_library_address = NativeLibrary.GetExport(s_kernel32_handle, Constants.LOAD_LIBRARY_FUNC);
    
    [LibraryImport(KERNEL32, SetLastError = true)]
    internal static partial int ResumeThread(SafeThreadHandle hThread);

    [LibraryImport(KERNEL32, SetLastError = true)]
    internal static partial IntPtr CreateRemoteThread(SafeProcessHandle hProcess, ...);
}
```

### 7. `ProcessHandler.cs`

Это низкоуровневый слой, который выполняет операции по управлению процессами. Он использует функции, импортированные из `NativeImports.cs`, для прямого взаимодействия с операционной системой.

- **Основные обязанности:**
   1. **`Create_Game_Process`**: Создает командную строку и запускает `gta_sa.exe` с флагом `CREATE_SUSPENDED`.
   2. **`Inject_DLL`**: Реализует технику инъекции DLL через создание удаленного потока. Это самая критическая функция, организующая выделение памяти, запись и удаленное выполнение `LoadLibraryA`.
   3. **`Resume_Game_Thread`**: Выполняет заключительный этап "размораживания" основного потока игры.

```csharp
// Фрагмент из ProcessHandler.cs
internal static bool Inject_DLL(SafeProcessHandle process_handle, string dll_path, out string error_message) {
    // ... Выделение и запись в удаленную память ...

    IntPtr remote_thread = Native_Imports.CreateRemoteThread(process_handle, IntPtr.Zero, 0, Native_Imports.load_library_address, remote_memory, 0, IntPtr.Zero);

    if (remote_thread == IntPtr.Zero)
        return (error_message = $"Failed to create a remote thread...") != null && false;
    
    // ... Ожидание завершения и проверка результата ...
    return true;
}
```

### 8. `SafeHandles.cs`

Этот файл реализует рекомендуемую практику взаимодействия: использование `SafeHandle` для управления неуправляемыми ресурсами. Это гарантирует, что дескрипторы процессов и потоков Windows освобождаются детерминированно и безопасно.

- **Основная ответственность:** Классы `SafeProcessHandle` и `SafeThreadHandle` наследуют от `SafeHandleZeroOrMinusOneIsInvalid`. Они инкапсулируют `IntPtr`, представляющий нативный дескриптор. Главное преимущество — реализация метода `ReleaseHandle`, который гарантированно вызывается средой выполнения .NET при удалении объекта (например, в конце блока `using`), предотвращая утечки ресурсов.

```csharp
// Фрагмент из SafeHandles.cs
internal sealed class SafeProcessHandle : SafeHandleZeroOrminusOneIsInvalid {
    // ... Конструкторы ...

    protected override bool ReleaseHandle() {
        // Этот вызов гарантирован .NET для освобождения нативного дескриптора.
        return Native_Imports.CloseHandle(handle);
    }
}
```

## Подробный цикл инъекции DLL

Процесс инъекции DLL — это последовательность критических шагов, которые должны быть выполнены с точностью для успеха. Библиотека **SA-MP Injector C#** организует это следующим образом:

### 1. Проверка ввода

Перед любым взаимодействием с системой все параметры, предоставленные пользователем (путь к папке с игрой, никнейм, IP, порт и пароль), проверяются `Input_Validator`. Это включает в себя:
- Проверку того, что никнейм находится в пределах допустимой длины и не пуст.
- Убедиться, что порт является допустимым числом и находится в допустимом диапазоне (1-65535).
- Подтверждение того, что `gta_sa.exe`, `samp.dll` и `omp-client.dll` (если `Injection_Type` — OMP) существуют по ожидаемым путям.

> [!NOTE]
> Этот превентивный шаг имеет основополагающее значение для предотвращения неожиданных сбоев API и предоставления четкой обратной связи пользователю.

### 2. Создание игрового процесса (приостановленного)

Библиотека использует `Native_Imports.CreateProcessA` для запуска `gta_sa.exe`. Однако ключевой деталью является использование флага `Constants.CREATE_SUSPENDED`.
- **Приостановленное создание:** Этот флаг заставляет Windows создать процесс и его основной поток, но переводит его в приостановленное состояние, не давая коду игры начать выполняться.
- **Командная строка:** Командная строка тщательно создается `Process_Handler.Build_Full_Command_Args_ANSI` для включения всех параметров подключения к серверу (`-c -n <никнейм> -h <ip> -p <порт> -z <пароль>`).
- **Дескрипторы процесса/потока:** `CreateProcessA` возвращает дескрипторы для процесса и основного потока, которые инкапсулируются в `SafeProcessHandle` и `SafeThreadHandle` для безопасного управления ресурсами.

> [!IMPORTANT]
> Приостановленное создание жизненно важно для инъекции. Если бы игра начала выполняться до инъекции, она могла бы инициализировать свои собственные механизмы безопасности, или `samp.dll`/`omp-client.dll` могли бы быть загружены до нашего контроля, что сделало бы инъекцию более сложной или неэффективной.

### 3. Инъекция `samp.dll`

Когда игровой процесс приостановлен, функция `Process_Handler.Inject_DLL` выполняет следующие шаги:
1. **Получение `LoadLibraryA`:** Получается адрес функции `LoadLibraryA` (из `kernel32.dll`) в процессе игры. Это функция, которую Windows использует для загрузки DLL.
2. **Выделение удаленной памяти:** `Native_Imports.VirtualAllocEx` используется для выделения блока памяти в виртуальном адресном пространстве процесса `gta_sa.exe`. Размер блока достаточен для хранения полного пути к `samp.dll`.
3. **Запись пути к DLL:** Полный путь к файлу `samp.dll` записывается в только что выделенную память в игровом процессе с помощью `Native_Imports.WriteProcessMemory`.
4. **Создание удаленного потока:** Вызывается `Native_Imports.CreateRemoteThread` для создания нового потока в процессе `gta_sa.exe`. Этому потоку дается указание выполнить `LoadLibraryA` с адресом строки пути к DLL в качестве единственного аргумента.
5. **Ожидание завершения:** Библиотека ожидает тайм-аут (`Constants.DLL_INJECTION_TIMEOUT_MS`), чтобы удаленный поток завершил свое выполнение, что указывает на то, что `LoadLibraryA` попыталась загрузить DLL.
6. **Проверка результата:** Проверяется код выхода удаленного потока. Если `LoadLibraryA` завершилась успешно, она возвращает базовый адрес загруженной DLL. Нулевое значение или сбой при получении кода выхода указывает на то, что инъекция не удалась.
7. **Очистка:** Выделенная удаленная память освобождается (`Native_Imports.VirtualFreeEx`), и дескриптор удаленного потока закрывается (`Native_Imports.CloseHandle`).

### 4. Инъекция `omp-client.dll` (необязательно, зависит от SA-MP)

> [!TIP]
> Инъекция `omp-client.dll` **всегда происходит после успешной инъекции `samp.dll`**. Клиент OMP использует инфраструктуру SA-MP, поэтому `samp.dll` является обязательным требованием.

Если указанный `Injection_Type` — `OMP`, шаг 3 повторяется для инъекции `omp-client.dll`. Логика идентична, что гарантирует загрузку обеих необходимых для OMP библиотек до полного запуска игры.

### Возобновление основного потока игры

Наконец, после успешной инъекции всех необходимых DLL, вызывается функция `Process_Handler.Resume_Game_Thread`. Эта функция использует `Native_Imports.ResumeThread`, чтобы позволить основному потоку `gta_sa.exe` продолжить свое выполнение. Теперь игра запускается с уже загруженными DLL SA-MP/OMP и примененными аргументами командной строки для подключения к серверу.

## Обработка ошибок и сбоев

Библиотека разработана для предоставления четкой обратной связи в случае сбоя. Большинство ошибок перехватываются, и возвращается описательное `error_message` для отображения пользователю, обычно через `MessageBox`.

### Ошибки проверки ввода

Эти ошибки возникают до любых системных операций и обнаруживаются `Input_Validator`.

#### Неверный никнейм

- **Сообщение об ошибке (Пример 1):** `"Nickname cannot be empty. Please provide a valid nickname."`
- **Сообщение об ошибке (Пример 2):** `"Nickname length exceeds the maximum allowed of 23 characters. Please use a shorter nickname."`
- **Почему:** Поле никнейма пустое или превышает максимальный лимит в 23 символа.
- **Решение:** Пользователь должен предоставить действительный никнейм, соответствующий ограничению по длине.

#### Неверный порт

- **Сообщение об ошибке (Пример 1):** `"Invalid port format. The port must be a numeric value. Please provide a valid integer for the port."`
- **Сообщение об ошибке (Пример 2):** `"The specified port number (70000) is outside the valid range of 1 to 65535. Please provide a valid port."`
- **Почему:** Указанный порт не является целым числом или находится вне допустимого диапазона от 1 до 65535.
- **Решение:** Пользователь должен ввести действительный номер порта в указанном диапазоне.

#### Отсутствующие файлы игры/DLL

- **Сообщение об ошибке (Пример 1):** `"Game executable not found. Please ensure 'gta_sa.exe' exists at the specified path: C:\Program Files (x86)\Rockstar Games\GTA San Andreas\gta_sa.exe"`
- **Сообщение об ошибке (Пример 2):** `"SA-MP library not found. Please ensure 'samp.dll' exists at the specified path: C:\Program Files (x86)\Rockstar Games\GTA San Andreas\samp.dll"`
- **Сообщение об ошибке (Пример 3, OMP):** `"OMP library not found. Please ensure 'omp-client.dll' exists at the specified path for OMP injection: C:\Program Files (x86)\Rockstar Games\GTA San Andreas\omp-client.dll"`
- **Почему:** Исполняемый файл игры (`gta_sa.exe`), DLL SA-MP (`samp.dll`) или DLL OMP (`omp-client.dll`) не найдены в указанной папке с игрой.
- **Решение:** Пользователь должен проверить путь к папке с игрой и убедиться, что все необходимые файлы присутствуют.

### Ошибки при создании процесса

Эти ошибки возникают, когда библиотека пытается запустить `gta_sa.exe`.

#### Ошибка создания процесса

- **Сообщение об ошибке (Пример):** `"Failed to create game process. Ensure 'gta_sa.exe' is not running and you have sufficient permissions to execute the file. System Error: Access is denied."`
- **Почему:**
   - **Файл используется:** `gta_sa.exe` уже может быть запущен, что мешает созданию нового экземпляра, или операционная система может блокировать файл.
   - **Разрешения:** У пользователя, запускающего приложение, может не быть достаточных разрешений для запуска нового процесса или доступа к исполняемому файлу игры.
   - **Неверный/поврежденный путь:** Хотя базовая проверка проверяет существование, могут быть проблемы с разрешениями на чтение/выполнение или исполняемый файл может быть поврежден.
- **Решение:** Убедитесь, что другие экземпляры `gta_sa.exe` не запущены. Запустите приложение от имени администратора, если это возможно. Проверьте целостность файла `gta_sa.exe`.

### Ошибки при инъекции DLL

Это самые критические ошибки, которые возникают при попытке инъекции `samp.dll` или `omp-client.dll` в игровой процесс.

#### Недоступен дескриптор `kernel32.dll`

- **Сообщение об ошибке:** `"Failed to obtain a handle to kernel32.dll. This is an essential system library and this error indicates a severe system issue."`
- **Почему:** Библиотека `kernel32.dll`, необходимая для системных операций в Windows, не может быть загружена или ее дескриптор не может быть получен. Это крайне редкое явление и указывает на серьезную проблему в операционной системе.
- **Решение:** Перезагрузка системы может помочь. В противном случае это указывает на более глубокую проблему с установкой Windows.

#### Недоступна функция `LoadLibraryA`

- **Сообщение об ошибке:** `"Failed to find the address of the LoadLibraryA function in kernel32.dll. This is critical for injecting the DLL."`
- **Почему:** Функция `LoadLibraryA`, необходимая для динамической загрузки DLL, не может быть найдена в `kernel32.dll`. Как и предыдущая ошибка, это редкая низкоуровневая проблема.
- **Решение:** Аналогично недоступности дескриптора `kernel32.dll`.

#### Ошибка выделения удаленной памяти

- **Сообщение об ошибке:** `"Failed to allocate memory in the target process. This might be due to insufficient permissions or process protection mechanisms."`
- **Почему:** Библиотека не смогла выделить блок памяти в адресном пространстве `gta_sa.exe`.
   - **Разрешения:** У приложения может не быть необходимых разрешений для изменения адресного пространства другого процесса.
   - **Защита процесса:** Процесс `gta_sa.exe` или операционная система могут применять защиту от инъекции кода.
   - **Адресное пространство:** В крайних случаях адресное пространство процесса может быть фрагментировано или не иметь достаточно непрерывной памяти, хотя это маловероятно для размера строки пути к DLL.
- **Решение:** Запустите приложение от имени администратора. Проверьте, есть ли программное обеспечение безопасности (антивирус, античит), которое может блокировать выделение памяти в других процессах.

#### Ошибка записи в память процесса

- **Сообщение об ошибке:** `"Failed to write DLL path to the target process memory. Verify process permissions and ensure the DLL path is accessible."`
- **Почему:** Библиотека выделила память в игровом процессе, но не смогла записать путь к DLL в это место.
   - **Разрешения:** Аналогично ошибке выделения памяти, это может быть проблема с разрешением на запись.
   - **Защита:** Защита памяти операционной системы или античит могут препятствовать записи.
- **Решение:** Проверьте разрешения и программное обеспечение безопасности.

#### Ошибка создания удаленного потока

- **Сообщение об ошибке (Пример):** `"Failed to create a remote thread in the target process to execute the DLL injection. This could be due to security restrictions or process state. System Error: Not enough memory resources are available to process this command."`
- **Почему:** API `CreateRemoteThread` не смог создать новый поток в процессе `gta_sa.exe` для вызова `LoadLibraryA`.
   - **Защита процесса/античит:** Многие античитерские системы и защиты операционной системы отслеживают и блокируют создание удаленных потоков, так как это распространенная техника инъекции.
   - **Состояние процесса:** Игровой процесс может находиться в неконсистентном состоянии, которое препятствует созданию потоков.
- **Решение:** Временно отключите любое античитерское или антивирусное программное обеспечение. Попробуйте запустить приложение от имени администратора.

#### Тайм-аут или ошибка ожидания инъекции

- **Сообщение об ошибке (Пример):** `"Timeout or error waiting for DLL injection to complete. System Error: The wait operation timed out."`
- **Почему:** Удаленный поток (который вызывает `LoadLibraryA`) не завершил свое выполнение в течение указанного тайм-аута (10 секунд).
   - **Зависание:** `LoadLibraryA` мог зависнуть или выполняться слишком долго.
   - **Блокировка:** Какой-либо механизм безопасности мог перехватить и заблокировать выполнение `LoadLibraryA` на неопределенное время.
- **Решение:** Это может указывать на то, что DLL загружается слишком долго или что-то мешает этому. Проверка системных логов или логов SA-MP/OMP (если они есть) может помочь.

#### Инъекция DLL не удалась или вернула ошибку

- **Сообщение об ошибке:** `"DLL injection failed or returned an error. The LoadLibrary call may have failed in the target process."`
- **Почему:** Удаленный поток завершился, но код выхода `LoadLibraryA` указал на сбой (обычно `0` или `NULL`).
   - **Несуществующая/поврежденная DLL:** Несмотря на первоначальную проверку, DLL могла быть перемещена или повреждена между проверкой и инъекцией.
   - **Отсутствующие зависимости DLL:** `samp.dll` или `omp-client.dll` могут зависеть от других DLL, которые отсутствуют в каталоге игры или в системном PATH.
   - **Внутренняя ошибка DLL:** Сама DLL может иметь внутреннюю ошибку, которая мешает ей правильно загрузиться.
- **Решение:** Проверьте целостность `samp.dll`/`omp-client.dll`. Убедитесь, что все зависимости DLL присутствуют.

### Ошибка при возобновлении потока игры

Это последняя возможная ошибка в цикле инъекции.

- **Сообщение об ошибке (Пример):** `"Failed to resume the game process thread: Invalid handle."`
- **Почему:** API `ResumeThread` не смог возобновить основной поток `gta_sa.exe`.
   - **Неверный дескриптор:** Дескриптор потока мог быть аннулирован по какой-либо причине.
   - **Проблема с разрешениями:** У приложения может не быть разрешения на изменение состояния потока.
- **Решение:** Попробуйте запустить приложение от имени администратора. Если проблема сохраняется, это может указывать на более глубокую проблему стабильности системы или игрового процесса.

## Лицензия

Copyright © **SA-MP Programming Community**

Данное программное обеспечение лицензируется в соответствии с условиями лицензии MIT ("Лицензия"); вы можете использовать это программное обеспечение в соответствии с условиями Лицензии. Копию Лицензии можно получить по адресу: [MIT License](https://opensource.org/licenses/MIT)

### Условия использования

#### 1. Предоставленные разрешения

Настоящая лицензия бесплатно предоставляет любому лицу, получающему копию данного программного обеспечения и связанных с ним файлов документации, следующие права:
* Использовать, копировать, изменять, объединять, публиковать, распространять, сублицензировать и/или продавать копии программного обеспечения без ограничений
* Разрешать лицам, которым предоставляется программное обеспечение, делать то же самое при соблюдении указанных ниже условий

#### 2. Обязательные условия

Все копии или существенные части программного обеспечения должны включать:
* Вышеуказанное уведомление об авторских правах
* Данное уведомление о разрешении
* Приведенное ниже заявление об отказе от ответственности

#### 3. Авторские права

Программное обеспечение и вся связанная с ним документация защищены законами об авторских правах. **SA-MP Programming Community** сохраняет за собой оригинальные авторские права на программное обеспечение.

#### 4. Отказ от гарантий и ограничение ответственности

ПРОГРАММНОЕ ОБЕСПЕЧЕНИЕ ПРЕДОСТАВЛЯЕТСЯ "КАК ЕСТЬ", БЕЗ КАКИХ-ЛИБО ГАРАНТИЙ, ЯВНЫХ ИЛИ ПОДРАЗУМЕВАЕМЫХ, ВКЛЮЧАЯ, НО НЕ ОГРАНИЧИВАЯСЬ ГАРАНТИЯМИ ТОВАРНОЙ ПРИГОДНОСТИ, ПРИГОДНОСТИ ДЛЯ КОНКРЕТНОЙ ЦЕЛИ И НЕНАРУШЕНИЯ ПРАВ.

НИ ПРИ КАКИХ ОБСТОЯТЕЛЬСТВАХ АВТОРЫ ИЛИ ПРАВООБЛАДАТЕЛИ НЕ НЕСУТ ОТВЕТСТВЕННОСТИ ЗА ЛЮБЫЕ ПРЕТЕНЗИИ, УБЫТКИ ИЛИ ИНУЮ ОТВЕТСТВЕННОСТЬ, БУДЬ ТО В СИЛУ ДОГОВОРА, ДЕЛИКТА ИЛИ ИНЫМ ОБРАЗОМ, ВОЗНИКАЮЩИЕ ИЗ, ИЗ-ЗА ИЛИ В СВЯЗИ С ПРОГРАММНЫМ ОБЕСПЕЧЕНИЕМ ИЛИ ИСПОЛЬЗОВАНИЕМ ИЛИ ИНЫМИ ДЕЙСТВИЯМИ С ПРОГРАММНЫМ ОБЕСПЕЧЕНИЕМ.

---

Для подробной информации о лицензии MIT посетите: https://opensource.org/licenses/MIT